% !TEX root = ../../main.tex

\section{Attack coordinator}
\label{sec:attack_coordinator}
The attack coordinator has but one feature, that is to coordinate attacks. Squads can request attacks from the attack coordinator and it will search for a good location to attack. Before describing the algorithms, you need to know that attacks can be grouped into two categories: frontal attacks, and distracting attacks.

Frontal attacks attack the enemy head on and usually use the majority of the player’s army, distracting attacks are small attacks either used to distract the enemy from one position where another attack will come (hence the name), or they can be used to try to deal some damage to the enemy, with heavy emphasis on try. These distracting attacks can be drops, harassment, counter-attacks\footnote{A drop when we are under attack can be called counter-attack, but our meaning of counter-attack is a frontal attack, but smaller}—BATS has, in time of this writing, only implemented the drop functionality. Most of the distracting attacks are not suicide attacks, and some does not even have to deal any damage to be successful as the goal is to draw away the enemy forces from a well-defended area, our expansion, or any other important area.

\paragraph{Where to attack?}
The attack coordinator uses two to three weights multiplied together to get the near optimal attack location—the attack location is not optimal and that the weights have not been extensively balanced, but the algorithm works well. The attacking locations are derived from seen enemy structures and expansions that have not been scouted for \attackCoordinatorExpansionNotCheckedTime.

The first weight, \emph{distance}, prioritizes structures (and location) far away from other existing attacks, not including allied attacks yet; as it is a good idea to spread out multiple attack to split up the enemy army. The second weight, \emph{type}, determines how important a structure or location is to attack, and the third weight, \emph{defended}, is how well defended an area is—the defended weight is not implemented yet, but distracting attacks would use it to get a location that can be attacked without taking the risk to die (such as drops dying to anti-air).

In addition to these weights, if the squad is a frontal attack and follows an allied squad, it will get an attack position near the allied squads target instead of using the weights. The attack position is still the same positions used for the regular algorithm.

Enemy armies are not included in the calculation, because one rarely gain anything on trading armies, one should find gaps in the defense instead\cite{day9}. While it would be good to engage and attack an enemy army if its a lot weaker than our BATS will still do that if the squad is close by, but it will not search for those small armies. In addition, because armies are mobile it would be hard to keep a track on them.

The flowchart in figure \ref{fig:AttackCoordinator::requestAttack()} shows how an attack squad can request an attack and either if it join forces with the allied player or calculates a good position to attack.
\begin{figure}[htb]
\centering
	\begin{tikzpicture}[->,>=stealth,shorten >=1pt,auto,node distance=3.8cm]
		\node [block] (init) {Request attack};
		\node [decision, below of=init] (player_frontal) {Player has frontal};
		\node [block, right of=player_frontal] (find_places) {Find places to attack};
		\node [decision, right of=find_places] (bot_frontal) {Squad is frontal attack};
		\node [block, right of=bot_frontal] (defend) {Calculate defended weights};
		\node [decision, below of=player_frontal] (bot_frontal2) {Squad is frontal attack};
		\node [block, below of=bot_frontal2] (join_forces) {Join forces with player};
		\node [block, below of=bot_frontal] (distance) {Calculate distance weights};
		\node [block, below of=distance] (type) {Calculate type weights};
		\node [block, right of=type] (select) {Select position with highest weight};
		
		\path [line] (init) -- (player_frontal);
		\path [line] (player_frontal) -- node [near start] {no} (find_places);
		\path [line] (player_frontal) -- node [near start] {yes} (bot_frontal2);
		\path [line] (bot_frontal2) -- node [near start] {yes} (join_forces);
		\path [line] (bot_frontal2) -| node [near start] {no} (find_places);
		\path [line] (find_places) -- (bot_frontal);
		\path [line] (bot_frontal) -- node [near start] {no} (defend);
		\path [line] (bot_frontal) -- node [near start] {yes} (distance);
		\path [line] (defend) |- (distance);
		\path [line] (distance) -- (type);
		\path [line] (type) -- (select);
	\end{tikzpicture}
	\caption{Flowchart of Attack Coordinator’s requestAttack() function.}
	\label{fig:AttackCoordinator::requestAttack()}
\end{figure}

\paragraph{Coordinated attacks}
To achieve a sense of coordinated attacks, attack squads have \nameref{sec:wait_goals} added by the attack coordinator—fully described in section \ref{sec:wait_goals}. The wait goal for attack squads is a wait goal that succeeds whenever an attack is within position (close to its goal and waiting), or is already attacking something. The goal fails when it has timed out (\attackCoordinatorWaitGoalTimeout). The wait goal is added to all existing squads and the new squad gets the already existing wait goals, when all attacks are in position they will start their attack simultaneously.

\subsection{Calculation of distance weight}
Distance weight is a simple calculation: if no other attack squads are present it defaults to 1.0. Otherwise the average from all other attacking squads are calculated as described in equation \ref{eq:distance_weight}.
\begin{equation}
\label{eq:distance_weight}
weight = \frac{\sum_{i=1}^{s}{distance(i)^2}}{s} \qquad \left\{s = \text{number of attack squads}\right.
\end{equation}
Here \emph{weight} is the average distance from all other attacking squads. The weight is then normalized to [0.0, 1.0], shown in equation \ref{eq:distance_weight_normalized}—dividing the weight with the maximum map distance. As with most distance calculations, they use the squared version for faster calculation since no root calculations are needed.
\begin{equation}
\label{eq:distance_weight_normalized}
normalized\ weight = \frac{weight}{MAP\_WIDTH^2 + MAP\_HEIGHT^2}
\end{equation}


\subsection{Calculation of type weight}
This weight prioritizes different structures and locations. Most of the values here are fixed and one type calculated between fixed values (expansions). The structures and locations are presented in priority order below with the current values assign to them. These values are rough estimates what might be good, thus one shall not think these are \emph{the} values. Because of multiplying these values with other weights the difference between 0.1 and 0.2 is greater than 0.2 and 0.3 (0.2 is the double of 0.1).

\paragraph{Not scouted expansions \attackCoordinatorWeightsExpansionNotChecked}
These are expansion that have not been visited for the last \attackCoordinatorExpansionNotCheckedTime. The idea is to check expansions when moving out to attack, although the current version does not work as expected. Because the \nameref{sec:scout_squad} cannot cover all the areas quickly the attack squad will act more as a scout than attack squad because of visiting expansions in various location around the map. To fix this only the closest expansions to the enemy shall be checked and possibly only one with this squad, as this is roughly what Magnusson has observed when watching professional StarCraft players. This feature has been disable until it has been fixed.
	
\paragraph{Expansions \attackCoordinatorWeightsExpansionMinMax}
This expansion weight is for existing expansions of the enemy. The weight is higher for fresh expansions; this is done by checking how many minerals (in fractions) are left around the expansion—the \nameref{sec:resource_counter} keeps track of the minerals. The minimum value can, in addition to its normal state, be used as a kind of ceiling function; e.g. if it is set to ceil\conf (in the bot it is \attackCoordinatorWeightsExpansionCeil) and the minimum is set to 0.5 while only 20\% of the minerals are left it will ceil the weight to 0.5, see equation \ref{eq:weight_expansion_ceil}. If it is set to normal, the fraction will be normalized in the [0.5, 1.0] range, meaning the weight will be 0.6, see equation \ref{eq:weight_expansion_normal}.
\begin{equation}
\label{eq:weight_expansion_ceil}
weight =
\begin{cases}
minValue & if $fracMinerals(x) < minValue$ \\
fracMinerals(x) & if $fracMinerals(x) \geq minValue$
\end{cases}
\end{equation}
\begin{equation}
\label{eq:weight_expansion_normal}
weight = fracMinerals(x) \times (maxValue - minValue) + minValue
\end{equation}

\paragraph{Addons \attackCoordinatorWeightsAddonStructure}
Addons are structures built in connection to another structure and only exist for Terran. These are both upgrade structures and can make either the attached unit producing structure create advanced units (such as tanks), or all specific unit producing structures able to produce the unit—e.g. the addon Covert Ops for a Science Facility makes Ghosts available for production in all Barracks. The only exception to this is the addons to the Command Center which is either Comsat for detection or Nuclear Silo for nukes.

\paragraph{Supplies \attackCoordinatorWeightsSupplyStructure}
Supplies are structures that provide space (or food) for more units to be created, see section \ref{sec:starcraft_supply} for how supplies work. This supply priority only makes sense for Terran as they work differently for the other classes: Protoss also uses their for powering buildings, i.e. a higher priority would be good here; for Zerg the supplies are increased by the Overlord unit, this would require an additional algorithm for searching for Overlords, the priority would be higher, maybe even higher for only air attacks.

\paragraph{Upgrade structures \attackCoordinatorWeightsUpgradeStructure}
Upgrade structures are not all structures that can upgrade, only structures that can upgrade some general attack and defense bonuses are treated as upgrade structures. Meaning Terran Acadamy (which upgrades Stim for Marines) is not treated as an upgrade structure. The reason for this is because of simplicity; attack and defense upgrades come in three steps meaning there are 6–12 upgrades in total (depending on what structure) for that structure and is continued to be upgraded throughout the game. This means its a lot bigger chance that the building still is useful (for the enemy) even when attacking it later in the game, as opposed to the Acadamy which upgrades are long done—although in this case medics and firebats could not be created by the enemy, but the enemy can simply prioritize marines in the meanwhile and not much harm would be done.

As an improvement BATS could keep track of which upgrades it has seen and then exclude these buildings. Attack and defense upgrades can be directly seen on the enemy while unit abilities, e.g. stim, needs to be activated by the enemy for BATS to know about it.

\paragraph{Unit producing structure \attackCoordinatorWeightsUnitProducingStructure}
All structures that can produce units. These are not ordered in any specific order, not to say that it does not matter because it does, but it will always vary depending on the situation. If the enemy has 10 barracks and 1 Starport, it is probably best to destroy the Starport, whereas if the enemy has 1 barrack and 4 Starports it is probably best to destroy the barracks.

\paragraph{Other structures \attackCoordinatorWeightsOtherStructure}
Not much to say, all other structures that have not been covered, such as Terran Acadamy.

\subsubsection{Why this order?}
Because StarCraft is mostly about managing expansions\cite{day9}, BATS tries to deny and kill fresh expansions as its first priority (the top two priorities). Targeting addons can both stop the production of an important upgrade (siege mode for tanks) and the ability to create tanks, ghosts, etc. Delaying late game units is usually good as they are generally better than early game units. Supply depots are almost always good to destroy since it halts all unit production, unless the enemy has stacked up lots of supplies—which almost always is a bad strategy—or lost many units in a recent battle. Stopping an upgrade is probably better than killing a unit producing structure, because if the upgrade finishes all existing units will get the upgrade, while if we kill a unit producing structure only 2–4 units will get stopped, but it depends on the type of unit producing structure, what upgrade structure etc; but this priority will do for now.