% !TEX root = ../../main.tex
\section{Squads}
A squad in this sense is units grouped together that act together, like a squad in real battle. All squads have the Squad class as their base class. 

\paragraph{Creating, deleting, and retrieving squads}
The squad manager class handles all existing squads, new squads are all automatically inserted into the squad manager (via the squad's constructor). Squad manager stores all squads as \texttt{shared\_ptr} type, meaning they are automatically destroyed when no more references exist. When a squad holds no units—achieved when units die, move to another squad, or squad is disbanded—it is automatically deleted from the squad manager, but can still be found if another class saved it before deletion, this class needs to manually delete the squad. Squad that have been deleted from the squad manager cannot be inserted into the squad manager again, but have to be recreated; therefore it's good to retrieve the squad from the SquadManager in the first place, although it is a bit slower.

Squads can be retrieved using two options, either by the squad's id (automatically set) or by squad type (template function), shown in listing \ref{lst:SquadManager::getSquads()}. The template function will also return all sub-classes to the specified class, meaning \texttt{getSquads<AttackSquad>();} would return both attack squads and drop squads because drop squad is derived from attack squad.
\begin{lstlisting}[caption={Template function to retrieve squads of the specified type.},label={lst:SquadManager::getSquads()}]
template <typename T>
vector<shared_ptr<T>> SquadManager::getSquads();
\end{lstlisting}

\subsection{The squad base class}
There are many features in the squad class, where most of them are helper functions, but only core features are explained in the text. If the reader wants more information, s/he can look in Appendix \ref{sec:doxygen}. First squad movement will be covered, then the squad's basic behaviors, which can be overridden by derived classes. Finally how the \texttt{update()} and \texttt{updateDerived()} functions work.

\paragraph{Squad movement}
This is not how the squad moves, but where the squad's units move to. The potential field manager takes care of how units move and was already implemented in BTHAI—although some changes have been made to the potential field manager to accept some general squad behavior. The squad has five prioritized locations it can move to. Starting from the lowest priority is
\begin{enumerate}
	\item the goal location where the squad want to go to do their main task (e.g. scout, attack, defend position);
	\item while it's good to go there we always want to be able to retreat from an attack or anything else, this is where the retreat position comes into play, only derived squads can set this and \texttt{onRetreatCompleted()} is called when the retreat has succeeded or failed;
	\item to move to either the goal location or retreat location we can use a via path with multiple locations, this is useful when retreating with a drop because otherwise the drop might run straight through the enemy location if not retreating the same way it came from;
	\item a temporary goal location, this when derived classes need an additional goal location, such as \nameref{sec:attack_squad}s waiting in a position to attack or \nameref{sec:hold_squad}s moving from their roaming area to the defended area when an enemy enters the defend perimeter. The temporary goal location is, however, disabled when a retreat position is active; and
	\item a regroup location, the regroup is automatically handled by the squad when units are too spread out—a unit is further away than 9\conf tiles from the squad's center, the regroup stops again when all units are within 6\conf tiles. Currently the regroup position will be set to the center of the squad, this is not ideal but works for now. Bugs occur when the squad is shaped as a C moving outside of a cliff, water, or space, the new regroup position will then be on top of the cliff which ground units might not have access to, whichever the case it can cause undesired behaviors, a better behavior would probably be to use one of the first units location for the regroup. The regroup functionality can be disabled by derived classes, useful when sending reinforcements 
\end{enumerate}

\paragraph{Behaviors}
The squad has four elements that can change the behavior of the squad.
\begin{itemize}
	\item \emph{Regrouping}, which has been fully described above in squad movement.
	\item A squad can contain a \emph{unit composition}, this limits the squad to only contain units of the specific type, useful when creating special type of squads. Section \ref{sec:unit_composition} describes unit composition in more detail.
	\item Some squads usually don't want to get close to enemies, in this case \emph{avoid enemies} can be turned on. This causes attacking units to move to a specific position without attacking (even if they walk straight through enemies); this is due to potential field manager in BTHAI did not support this behavior entirely, thus a simpler version that just uses regular path finding is used due to lack of time to change the potential field algorithm in the manager.
	\item \emph{Wait goals} has been briefly described before in \nameref{sec:attack_coordinator} and is fully described in section \ref{sec:wait_goals}, \nameref{sec:wait_goals}. While adding these does not give the basic squad any specific behavior (yet), they can be used in the derived classes for certain behaviors.
\end{itemize}

\subsection{Attack squad}
\label{sec:attack_squad}

\subsection{Drop squad}

\subsection{Hold squad}
\label{sec:hold_squad}

\subsection{Patrol squad}

\subsection{Scout squad}

\subsection{Unit composition}
\label{sec:unit_composition}

\subsection{Wait goals}
\label{sec:wait_goals}